{% extends "templates/web.html" %}

{% block content %}
<!-- ===== MedStat Dynamic List Page (single file: HTML + CSS + JS) ===== -->
<div class="medstat-container">
    <h2 class="medstat-page-title">{{ page_title }}</h2>

    <div class="medstat-top-bar">
        <div class="medstat-left-controls">
            <button class="medstat-add-btn">+ Add</button>
        </div>

        <div class="medstat-right-controls">
            <label for="medstat-search" class="medstat-search-label">Search</label>
            <input type="search" id="medstat-search" class="medstat-search-input" placeholder="Type to filter...">
        </div>
    </div>

    <div class="medstat-table-wrapper">
        <table class="medstat-table" id="medstat-data-table" role="table" aria-label="{{ page_title }}">
            <thead>
                <tr>
                    {% for col in columns %}
                        <th scope="col">{{ col.label }}</th>
                    {% endfor %}
                    <th scope="col">Settings</th>
                </tr>
            </thead>

            <tbody id="medstat-table-body">
                {% for row in data %}
                <tr>
                    {% for col in columns %}
                        <td>{{ row[col.fieldname] }}</td>
                    {% endfor %}
                    <td class="medstat-settings-cell">
                        <button class="medstat-settings-btn" aria-expanded="false" title="Settings">⚙</button>
                        <div class="medstat-settings-dropdown" role="menu">
                            <a href="#" role="menuitem">Option 1</a>
                            <a href="#" role="menuitem">Option 2</a>
                            <a href="#" role="menuitem">Option 3</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="medstat-bottom-bar">
        <span id="medstat-total-records">Total Records: {{ total }}</span>
        <div class="medstat-bottom-actions">
            <button id="medstat-load-more-btn" class="medstat-load-more-btn">More</button>
        </div>
    </div>
</div>

<!-- expose values to JS -->
<script>
    const MEDSTAT_DOCTYPE = "{{ doctype }}";
    const MEDSTAT_COLUMNS = {{ columns | tojson }};
    let MEDSTAT_START = {{ limit }};
    const MEDSTAT_LIMIT = {{ limit }};
</script>

<style>
/* ===== MedStat namespaced styles (Bootstrap-safe) ===== */

.medstat-container {
    padding: 100px 20px;
    font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    color: #2b2b2b;
}

/* Header / Top bar */
.medstat-page-title {
    font-size: 1.6rem;
    font-weight: 700;
    margin: 0 0 12px 0;
    color: #2e0249;
}

.medstat-top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
}

.medstat-left-controls { display:flex; gap:8px; align-items:center; }
.medstat-right-controls { display:flex; gap:8px; align-items:center; }

.medstat-add-btn {
    background: linear-gradient(180deg,#8a33c3,#6c1f99);
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(108,31,153,0.12);
}

.medstat-search-label { font-size: 13px; color: #5b3a66; }
.medstat-search-input {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #e6d7f0;
    min-width: 220px;
    outline: none;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.02);
}

/* Table wrapper to allow horizontal scroll */
.medstat-table-wrapper {
    overflow: auto;
    border-radius: 10px;
    background: #ffffff;
    box-shadow: 0 6px 20px rgba(46,2,73,0.06);
}

/* table base */
.medstat-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px; /* allow small screens to scroll */
}

/* cells */
.medstat-table th,
.medstat-table td {
    padding: 12px 14px;
    border-bottom: 1px solid rgba(46,2,73,0.06);
    white-space: nowrap;
    vertical-align: middle;
    font-size: 14px;
}

/* header styling (purple) */
.medstat-table th {
    position: sticky;
    top: 0;
    background: linear-gradient(180deg,#7d1fa4,#61147f);
    color: #fff;
    font-weight: 700;
    text-align: left;
    z-index: 4;
}

/* row striping */
.medstat-table tbody tr:nth-child(odd) {
    background: #fff;
}
.medstat-table tbody tr:nth-child(even) {
    background: #fbf0ff;
}

/* hover */
.medstat-table tbody tr:hover {
    background: #f3e8ff;
}

/* Freeze first column */
.medstat-table th:first-child,
.medstat-table td:first-child {
    position: sticky;
    left: 0;
    z-index: 5;
    background-clip: padding-box;
    background: linear-gradient(180deg,#fff,#fff);
}

/* Freeze last column (Settings column) */
.medstat-table th:last-child,
.medstat-table td:last-child {
    position: sticky;
    right: 0;
    z-index: 5;
    background-clip: padding-box;
    background: linear-gradient(180deg,#fff,#fff);
    text-align: center;
}

/* icons / small cells */
.medstat-settings-cell { position: relative; width: 64px; }

/* settings button */
.medstat-settings-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 6px;
    border-radius: 6px;
}

/* dropdown */
.medstat-settings-dropdown {
    display: none;
    position: absolute;
    top: 38px;
    right: 6px;
    min-width: 140px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 8px 20px rgba(46,2,73,0.12);
    padding: 6px 6px;
    z-index: 60;
}

.medstat-settings-dropdown a {
    display: block;
    padding: 8px 10px;
    text-decoration: none;
    color: #2b2b2b;
    border-radius: 6px;
    font-size: 14px;
}

.medstat-settings-dropdown a:hover {
    background: #f3eef8;
}

/* bottom bar */
.medstat-bottom-bar {
    margin-top: 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
}

.medstat-load-more-btn {
    background: linear-gradient(180deg,#7d1fa4,#61147f);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

/* responsive tweaks */
@media (max-width: 820px) {
    .medstat-search-input { min-width: 120px; }
    .medstat-table { min-width: 720px; }
}

/* stronger specificity to beat bootstrap where necessary */
.medstat-table th:first-child,
.medstat-table td:first-child,
.medstat-table th:last-child,
.medstat-table td:last-child {
    background: #fff !important;
}
</style>

<script>
/* ===== MedStat JS (dynamic columns / more / dropdown / search) ===== */

(function () {
    // helper: create cell text safely
    function safeText(v) { return (v === null || v === undefined) ? "" : String(v); }

    // toggle a single dropdown and close others
    function toggleDropdown(btn) {
        const dd = btn.nextElementSibling;
        document.querySelectorAll(".medstat-settings-dropdown").forEach(d => {
            if (d !== dd) d.style.display = "none";
        });
        dd.style.display = dd.style.display === "block" ? "none" : "block";
        btn.setAttribute("aria-expanded", dd.style.display === "block");
    }

    // close all dropdowns
    function closeAllDropdowns() {
        document.querySelectorAll(".medstat-settings-dropdown").forEach(d => d.style.display = "none");
        document.querySelectorAll(".medstat-settings-btn").forEach(b => b.setAttribute("aria-expanded", "false"));
    }

    // add a row (object) to tbody based on MEDSTAT_COLUMNS
    function appendRow(tbody, rowObj) {
        const tr = document.createElement("tr");

        MEDSTAT_COLUMNS.forEach(col => {
            const td = document.createElement("td");
            td.innerText = safeText(rowObj[col.fieldname]);
            tr.appendChild(td);
        });

        // settings column
        const tdSettings = document.createElement("td");
        tdSettings.className = "medstat-settings-cell";
        tdSettings.innerHTML = `
            <button class="medstat-settings-btn" title="Settings">⚙</button>
            <div class="medstat-settings-dropdown" role="menu">
                <a href="#" data-action="action1">Option 1</a>
                <a href="#" data-action="action2">Option 2</a>
                <a href="#" data-action="action3">Option 3</a>
            </div>
        `;
        tr.appendChild(tdSettings);
        tbody.appendChild(tr);
    }

    // initial wiring
    document.addEventListener("DOMContentLoaded", function () {
        const tbody = document.getElementById("medstat-table-body");
        const loadMoreBtn = document.getElementById("medstat-load-more-btn");
        const searchInput = document.getElementById("medstat-search");

        // global click handler to handle settings button (event delegation)
        document.addEventListener("click", function (ev) {
            const target = ev.target;

            // settings button clicked
            if (target.classList && target.classList.contains("medstat-settings-btn")) {
                ev.stopPropagation();
                toggleDropdown(target);
                return;
            }

            // settings dropdown option clicked (delegation)
            if (target.closest && target.closest(".medstat-settings-dropdown")) {
                ev.preventDefault();
                const action = target.getAttribute("data-action");
                if (action) {
                    // handle actions here (customize per your need)
                    // Example: open a modal, navigate, call endpoint...
                    frappe.msgprint(`Clicked ${action} on row`);
                }
                closeAllDropdowns();
                return;
            }

            // click outside -> close dropdowns
            closeAllDropdowns();
        });

        // search filter
        searchInput.addEventListener("input", function () {
            const filter = this.value.trim().toLowerCase();
            document.querySelectorAll("#medstat-table-body tr").forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
            });
        });

        // load more click
        loadMoreBtn.addEventListener("click", function () {
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerText = "Loading...";

            frappe.call({
                // ensure this path matches your python module path for load_more_data
                method: "custom_app.www.custom_list.load_more_data",
                args: {
                    doctype_name: MEDSTAT_DOCTYPE,
                    start: MEDSTAT_START,
                    limit: MEDSTAT_LIMIT
                },
                callback: function (r) {
                    if (r.message && r.message.length) {
                        r.message.forEach(row => appendRow(tbody, row));
                        MEDSTAT_START += MEDSTAT_LIMIT;
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.innerText = "More";
                    } else {
                        // no more rows
                        loadMoreBtn.style.display = "none";
                    }
                },
                error: function () {
                    frappe.msgprint("Failed to load more data");
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.innerText = "More";
                }
            });
        });

        // accessibility: close dropdowns with ESC
        document.addEventListener("keydown", function (ev) {
            if (ev.key === "Escape") closeAllDropdowns();
        });
    });

})();
</script>

{% endblock %}
