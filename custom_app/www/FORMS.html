{% extends "templates/web.html" %}

{% block title %}
{{ _("WEB PORTAL") }}
{% endblock %}

{% block page_content %}

<div class="formbold-main-wrapper">
    <div class="formbold-form-wrapper">
        <div class="ms-card">
            <div class="wizard-progress">
                {% set tab_fields = fields | selectattr("fieldtype", "equalto", "Tab Break") | list %}
                {% for tab in tab_fields %}
                    <div class="step {% if loop.first %}current{% endif %}">
                        <div class="node"></div>
                        <span>{{ tab.label or "Step " ~ loop.index }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>

        <br><br><br><br>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <form method="POST">
            {% for field in fields %}
                {% if field.fieldtype == "Tab Break" %}
                    {% if loop.index != 1 %}</div></div></div>{% endif %}
                    <div class="formbold-section {% if loop.first %}active{% endif %}" id="{{ field.fieldname }}">
<div class="tab-header-bar">
    <span class="tab-header-text">{{ field.label or "Step " ~ loop.index }}</span>
</div>
                        <div class="formbold-column-wrapper">
                            <div class="formbold-column">
                {% elif field.fieldtype == "Column Break" %}
                            </div><div class="formbold-column">
                {% elif field.fieldtype == "Section Break" %}
                            <div class="formbold-section-break">
                                <h5>{{ field.label }}</h5>
                                {% if field.description %}<p>{{ field.description }}</p>{% endif %}
                            </div>
                {% else %}
                            <div class="formbold-mb-6">
                                <label class="formbold-form-label">
                                    {% if field.label %}{{ field.label }}{% endif %}
                                    {% if field.reqd %}<span style="color: red;">*</span>{% endif %}
                                    <!-- Add circular question mark with tooltip -->
                                    {% if field.description %}
                                        <span class="tooltip-container">
                                            <span class="question-circle">?</span>
                                            <span class="tooltip-text">{{ field.description }}</span>
                                        </span>
                                    {% endif %}
                                </label>
                                {% if field.fieldtype == "Data" %}
                                    <input type="text" class="formbold-form-input" name="{{ field.fieldname }}"
                                        {% if field.reqd %}required{% endif %}
                                        {% if field.read_only %}readonly{% endif %}/>
                                {% elif field.fieldtype == "Link" %}
                                    <div class="link-field-container">
                                        <input type="text" class="formbold-form-input link-field" name="{{ field.fieldname }}"
                                            data-doctype="{{ field.options }}"
                                            {% if field.reqd %}required{% endif %}
                                            {% if field.read_only %}readonly{% endif %}/>
                                        <div class="link-icons">
                                            <i class="fa fa-times clear-icon" style="display: none;"></i>
                                        </div>
                                        <div class="link-dropdown" id="dropdown-{{ field.fieldname }}"></div>
                                    </div>
                                {% elif field.fieldtype == "Date" %}
                                    <input type="date" class="formbold-form-input" name="{{ field.fieldname }}"
                                        {% if field.reqd %}required{% endif %}
                                        {% if field.read_only %}readonly{% endif %}/>
                                {% elif field.fieldtype == "Phone" %}
                                    <input type="tel" class="formbold-form-input" name="{{ field.fieldname }}"
                                        {% if field.reqd %}required{% endif %}
                                        {% if field.read_only %}readonly{% endif %}/>
                                {% elif field.fieldtype == "Time" %}
                                    <input type="time" class="formbold-form-input" name="{{ field.fieldname }}"
                                        {% if field.reqd %}required{% endif %}
                                        {% if field.read_only %}readonly{% endif %}/>
                                {% elif field.fieldtype == "Datetime" %}
                                    <input type="datetime-local" class="formbold-form-input" name="{{ field.fieldname }}"
                                        {% if field.reqd %}required{% endif %}
                                        {% if field.read_only %}readonly{% endif %}/>
                                {% elif field.fieldtype in ["Int", "Currency"] %}
                                    <input type="number" class="formbold-form-input" name="{{ field.fieldname }}"
                                        {% if field.reqd %}required{% endif %}
                                        {% if field.read_only %}readonly{% endif %}/>
                                {% elif field.fieldtype in ["Small Text", "Text"] %}
                                    <textarea name="{{ field.fieldname }}" class="formbold-form-input"
                                        {% if field.reqd %}required{% endif %}
                                        {% if field.read_only %}readonly{% endif %}></textarea>
                                {% elif field.fieldtype == "Select" and field.options %}
                                    <select class="formbold-form-input" name="{{ field.fieldname }}"
                                        {% if field.reqd %}required{% endif %}
                                        {% if field.read_only %}disabled{% endif %}>
                                        {% for option in field.options.split("\n") %}
                                            <option value="{{ option }}">{{ option }}</option>
                                        {% endfor %}
                                    </select>
                                {% elif field.fieldtype == "Table MultiSelect" %}
                                    <div class="multiselect-container" id="multiselect-{{ field.fieldname }}">
                                        <div class="custom-textbox" id="input-{{ field.fieldname }}"
                                            onclick="fetchOptions('{{ field.fieldname }}', '{{ field.options }}')">
                                            <span class="placeholder">Select Files...</span>
                                        </div>
                                        <div class="multi-dropdown" id="multi-dropdown-{{ field.fieldname }}"></div>
                                    </div>
                                {% elif field.fieldtype == "Attach" %}
                                    <div class="upload-area"
                                         ondrop="handleDrop(event, '{{ field.fieldname }}-file')"
                                         ondragover="event.preventDefault()">
     
                                         <div class="drop-text">Drag & Drop</div>
                                         <div class="or-text">OR</div>
    
                                         <button type="button" class="browse-btn"
                                             onclick="document.getElementById('{{ field.fieldname }}-file').click()">
                                             Browse File
                                         </button>
                                        
                                         <input type="file"
                                             id="{{ field.fieldname }}-file"
                                             name="{{ field.fieldname }}"
                                             hidden
                                             multiple
                                             accept=".pdf,.jpg,.png,.jpeg"
                                             onchange="addFiles(event, '{{ field.fieldname }}-file-list')">
                                         <input type="hidden" id="form-id-hidden" value="{{ doc.name }}">
                                         <input type="hidden" id="username-hidden" value="{{ frappe.session.user }}">
                                   <div class="file-list" id="{{ field.fieldname }}-file-list"></div>
                                </div>

                                {% endif %}
                            </div>
                {% endif %}
                {% if loop.last %}
                            </div></div></div> <!-- Close column, wrapper, and tab -->
                {% endif %}
            {% endfor %}

            <!-- Navigation Buttons -->
            {% for field in fields if field.fieldtype == "Tab Break" %}
                <div class="form-navigation {% if loop.first %}first-tab{% endif %}" id="nav-{{ field.fieldname | replace(' ', '_') }}">
                    {% if not loop.first %}
                        <button type="button" class="prev-btn" onclick="changeTab(-1)">Back</button>
                    {% endif %}
                    <button type="button" class="next-btn" onclick="{% if loop.last %}submitForm(){% else %}changeTab(1){% endif %}">
                        {% if loop.last %}Submit{% else %}Next{% endif %}
                    </button>
                </div>
            {% endfor %}
        </form>
    </div>
</div>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

.question-circle {
    display: inline-block;
    width: 18px;
    height: 18px;
    background-color: #2c2f4a; 
    color: white;
    border-radius: 90%;
    text-align: center;
    line-height: 18px; 
    font-size: 12px;
    margin-left: px;
    cursor: pointer;
}

.tooltip-container {
    position: relative;
    display: inline-block;
}

.tooltip-text {
    visibility: hidden;
    width: 220px;
    background-color: #f5f6fa; 
    color: #2c2f4a; 
    text-align: left;
    padding: 8px 12px;
    border: 1px solid #e0e1e7; 
    border-radius: 6px;
    position: absolute;
    z-index: 1;
    bottom: 150%; 
    left: 0%; 
    margin-left: 0px; 
    opacity: 0;
    transition: opacity 0.3s;
    font-family: Arial, sans-serif; 
    font-size: 13px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
}

.tooltip-container:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

.tooltip-text::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 10px; 
    border-width: 6px;
    border-style: solid;
    border-color: #f5f6fa transparent transparent transparent; 
    border-left-color: transparent;
    border-right-color: transparent;
}

.tab-header-bar {
    background-color: #6a1b9a;
    padding: 10px 15px;
    color: white;
    font-weight: bold;
    border-radius: 5px 5px 0 0;
    font-size: 14px;
    margin-bottom: 30px;
    margin-top: -20px;
    margin-left: -20px;
    margin-right: -20px;
}
.tab-header-text {
    display: block;
}

.formbold-column-wrapper {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
}
.formbold-column {
    flex: 1;
    min-width: 300px;
}
/* MultiSelect Styles */
.multiselect-container {
    position: relative;
    width: 50%;
    max-width: 400px;
}
.custom-textbox {
    width: 122%;
    padding: 12px;
    border-radius: 5px;
    border: 1px solid #dde3ec;
    background: #ffffff;
    font-size: 16px;
    color: #536387;
    outline: none;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 5px;
    min-height: 40px;
    cursor: pointer;
    transition: 0.3s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.custom-textbox:hover,
.custom-textbox:focus-within {
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
}
.custom-textbox input {
    border: none;
    font-size: 16px;
    color: #536387;
    outline: none;
    flex-grow: 1;
    min-width: 100px;
    background: transparent;
    padding: 4px;
}
.placeholder {
    color: #999;
}
.multi-dropdown {
    position: absolute;
    background: white;
    border: 1px solid #dde3ec;
    border-radius: 5px;
    width: 122%;
    max-height: 200px;
    overflow-y: auto;
    display: none;
    z-index: 10;
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
    scrollbar-width: none;
}
.multi-dropdown::-webkit-scrollbar {
    display: none;
}
.dropdown-option {
    padding: 10px;
    font-size: 14px;
    cursor: pointer;
}
.dropdown-option:last-child {
    border-bottom: none;
}
.dropdown-option:hover {
    background: #f0f0f0;
}
.selected-item {
    background: #e1e1e1;
    padding: 5px 10px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
}
.remove-btn {
    cursor: pointer;
    color: red;
    font-weight: bold;
    font-size: 12px;
}

/* Link Field Styles */
.link-field-container {
    position: relative;
    width: 50%;
    display: flex;
    align-items: center;
}
.link-field-container input {
    width: 100%;
    padding: 12px;
    border-radius: 5px;
    border: 1px solid #dde3ec;
    background: #ffffff;
    font-size: 16px;
    color: #536387;
    outline: none;
    resize: none;
    transition: 0.3s;
}
.link-field-container input:focus {
    border-color: #007bff;
    outline: none;
}
.link-icons {
    position: absolute;
    right: 9px;
    display: flex;
    background: white;
    padding: px;
    border-radius: 4px;
    z-index: 10;
}
.link-icons i {
    font-size: 12px;
    cursor: pointer;
    color: #666 !important; /* Force the color to gray */
    transition: color 0.2s ease-in-out;
}
.link-icons i:hover {
    color: #333 !important; /* Force the hover color to darker gray */
}
.link-dropdown {
    position: absolute;
    width: 100%;
    max-height: 150px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: none;
    z-index: 9999;
    top: 100%;
    left: 0;
    scrollbar-width: none;
}
.link-dropdown::-webkit-scrollbar {
    display: none;
}
.dropdown-item {
    padding: 10px 15px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    background: white;
    transition: background 0.2s ease-in-out;
}
.dropdown-item:last-child {
    border-bottom: none;
}
.dropdown-item:hover {
    background: #f0f0f0;
}
.dropdown-item:active {
    background: #d9d9d9 !important;
    color: inherit !important;
}

/* Responsive Layout */
@media (max-width: 768px) {
    .multiselect-container,
    .link-field-container {
        width: 100%;
    }

    .custom-textbox,
    .multi-dropdown {
        width: 100%;
    }
}


.formbold-section-break {
        margin-top: 15px;
        margin-bottom: 10px;
        padding: 10px 0;
        border-bottom: 1px solid #ddd;
    }
.upload-area {
    text-align: center;
    padding: 40px;
    border: 2px dashed #9370DB;
    border-radius: 10px;
    background-color: #E6E6FA;
    color: #4B0082;
    margin: 10px 0;
}
.drop-text {
    font-size: 18px;
    font-weight: bold;
}
.or-text {
    margin: 10px 0;
    font-size: 14px;
}
.browse-btn {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}
.browse-btn:hover {
    background-color: #45a049;
}
.file-list {
    margin-top: 10px;
}
.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f3f4f6;
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 5px;
}
.progress-bar {
    width: 70%;
    height: 5px;
    background: #ccc;
    border-radius: 5px;
    margin-top: 5px;
    position: relative;
}
.progress-bar-fill {
    width: 100%;
    height: 100%;
    background: #e9d6f7;
    border-radius: 5px;
}
.remove-btn {
    background: none;
    border: none;
    color: #4B0082;
    cursor: pointer;
    font-weight: bold;


    margin-left: 5px;
}
.remove-btn:hover {
    color: #ff5c5c;
}

.formbold-section {
    display: none;
}
.formbold-section.active {
    display: block;
}
.form-navigation {
    display: flex;
    justify-content: space-between;
    padding: 20px;
    margin-top: 20px;

    position: sticky;
    bottom: 0;
    background: #fff;
    z-index: 10;      
}
.prev-btn, .next-btn, .submit-btn {
    padding: 10px 20px;
    background: #4B0082;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: 0.3s ease-in-out;
}
.prev-btn:hover, .next-btn:hover, .submit-btn:hover {
    background: #3a0066;
}
    .first-tab {
        justify-content: flex-end;
    }
.completed .node {
    background-color: #50d050 !important;
    color: white;
    text-align: center;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    width: 40px;  /* Adjust circle size */
    height: 40px;
    font-size: 22px;  /* Make tick bigger */
    border: 3px solid white; /* Outer white ring */
}
.completed .node::before {
    content: "✔"; 
    font-size: 40px; /* Adjust tick size */
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
}
.current .node {
    background-color: #726aeb !important; /* Gray color for the current tab */
    color: white;
    text-align: center;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 22px;
    border: 3px solid white;
}
.current .node::before {
    content: "↓"; 
    font-size: 40px; 
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
}
.error .node {
    background-color: #eb5858 !important;
    color: white;
    text-align: center;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    width: 40px;  /* Adjust circle size */
    height: 40px;
    font-size: 22px;  /* Make tick bigger */
    border: 3px solid white;
}
.error .node::before {
    content: "!";
    font-size: 40px; /* Adjust tick size */
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
}

.in-progress .node {
    background-color: gray !important;
    color: white;
    text-align: center;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    width: 40px;  /* Adjust circle size */
    height: 40px;
    font-size: 22px;  /* Make tick bigger */
    border: 3px solid white; font-weight: bold;
}

.in-progress .node::before {
    content: "↓";
    font-size: 40px;  /* Adjust to center properly */
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
} 

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    margin: 0 20px;
}

.stepper-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
    overflow: hidden; /* Prevents extra steps from showing */
}


.step.current {
    color: white;
    font-weight: bold;
}

.node {
    font-size: 18px;
}

.step.hidden {
    display: none; /* Hide steps when shifting */
}

.wizard-progress {
    & .step {
        .node {
            display: inline-block;
            border: 6px solid #4B0082;
            background-color: #fff;
            border-radius: 80px;
            height: 80px;
            width: 80px;
            position: absolute;
            top: 45px;
            left: 40%;
            margin-left: -18px;
        }
    }
}

.wizard-progress {
    & .step {
        &:not(:last-child):before {
            content: '';
            display: block;
            position: absolute;
            left: 50%;
            top: 80px;
            background-color: #07c;
            height: 6px;
            width: 100%;
            border: 1px solid #9C27B0 !important;
        }
    }
}

.step:last-of-type:before {
    display: none !important;
}

.last-visible::before {
    display: none !important;
}
.last-visible {
    margin-right: 10px; / Adjust this value to move the last step right /
}

.ms-card {
    background: #f0edf000;
    border-radius: 10px;
    padding: 20px;
    width: 100%; /* Make it stretch across */
    text-align: center;
    height: 200px;
    position: sticky;
    top: 0; /* This is necessary for sticky positioning */
    z-index: 700; /* Ensures it stays above other elements */
    background: white; /* Ensure visibility */
}

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f7ff;
      color: #333;
    }
    .formbold-sidebar {
        width: 250px;
        background: #007bff;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .formbold-sidebar button {
        background: white;
        color: #007bff;
        border: none;
        padding: 12px;
        margin-bottom: 10px;
        cursor: pointer;
        text-align: left;
        font-size: 16px;
        font-weight: bold;
        border-radius: 5px;
        transition: background 0.3s ease;
    }

    .formbold-sidebar button:hover, .sidebar button.active {
        background: #0056b3;
        color: white;
    }
    .formbold-section {
      display: none; /* Initially hidden */
      width: 100%;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fefaff;
      margin-top: -75px;
    }

    .formbold-section.active {
        display: block; /* Show only the active section */
    }

    .formbold-main-wrapper {
      display: flex;
      /* align-items: center; */
      justify-content: center;
      min-height: 100vh;
      max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    }
    .formbold-form-wrapper {
      min-width: 1100px;
      width: 100%;
      background: #fff;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.1);
    }
    .formbold-form-wrapper img {
      height: 20em;
      display: flex;
      justify-self: center;
      /* align-items: center; */
    }
    .formbold-form-input {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #dde3ec;
      background: #ffffff;
      font-size: 16px;
      color: #536387;
      outline: none;
      resize: none;
      transition: 0.3s;
      box-sizing: border-box;
    }
    .formbold-form-input:focus {
      border-color: #6a64f1;
      box-shadow: 0px 3px 8px rgba(0, 0, 0, 0.1);
    }
    .formbold-form-label {
      font-size: 14px;
      font-weight: 500;
      color: #07074d;
      margin-bottom: 5px;
      display: block;
    }
    .formbold-form-label h5 {
      /* text-align: center; */
      font-size: x-large;
      font-weight: bold;
      color: #9C27B0;
      text-decoration: underline;
    }
    .formbold-mb-6 {
      margin-bottom: 20px;
    }
    .formbold-radio-flex {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .formbold-radio-group {
      display: flex;
      align-items: center;
    }
    .formbold-radio-label {
      font-size: 14px;
      line-height: 24px;
      color: #07074d;
      position: relative;
      padding-left: 25px;
      cursor: pointer;
    }
    .formbold-input-radio {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }
    .formbold-radio-checkmark {
      position: absolute;
      top: 2px;
      left: 0;
      height: 19px;
      width: 19px;
      background-color: #ffffff;
      border: 2px solid #5f4fe9;
      border-radius: 50%;
    }
    .formbold-input-radio:checked ~ .formbold-radio-checkmark {
      background-color: #6a64f1;
    }
    .formbold-radio-checkmark:after {
      content: '';
      position: absolute;
      display: none;
    }
    .formbold-input-radio:checked ~ .formbold-radio-checkmark:after {
      display: block;
    }
    .formbold-radio-checkmark:after {
      top: 50%;
      left: 50%;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ffffff;
      transform: translate(-50%, -50%);
    }
    .formbold-btn {
      text-align: center;
      width: 100%;
      font-size: 16px;
      border-radius: 5px;
      padding: 14px 25px;
      border: none;
      font-weight: 500;
      background-color: #6a64f1;
      color: white;
      cursor: pointer;
      margin-top: 20px;
      transition: 0.3s;
    }
    .formbold-btn:hover {
      background-color: #5a54e6;
      box-shadow: 0px 3px 8px rgba(0, 0, 0, 0.1);
    }
    .formbold-steps {
    padding-bottom: 18px;
    margin-bottom: 35px;
    border-bottom: 1px solid #DDE3EC;
  }
  .formbold-steps ul {
    padding: 0;
    margin: 0;
    list-style: none;
    display: flex;
    gap: 40px;
  }
  .formbold-steps li {
    display: flex;
    align-items: center;
    gap: 14px;
    font-weight: 500;
    font-size: 16px;
    line-height: 24px;
    color: #536387;
  }
  .formbold-steps li span {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #DDE3EC;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-weight: 500;
    font-size: 16px;
    line-height: 24px;
    color: #536387;
  }
  .formbold-steps li.active {
    color: #07074D;;
  }
  .formbold-steps li.active span {
    background: #6A64F1;
    color: #FFFFFF;
  }

 .ios-checkbox { 
  position: relative;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

.ios-checkbox input {
  display: none;
}

.checkbox-wrapper {
  position: relative;
  width: 19px;
  height: 19px;
  border-radius: 4px;
  transition: transform 0.2s ease;
}

.checkbox-bg {
  position: absolute;
  inset: 0;
  border-radius: 4px;
  border: 2px solid #5f4fe9;
  background: white;
  transition: all 0.2s ease;
}

.checkbox-icon {
  position: absolute;
  inset: 0;
  margin: auto;
  width: 80%;
  height: 80%;
  color: white;
  transform: scale(0);
  transition: all 0.2s ease;
}

.check-path {
  stroke-dasharray: 40;
  stroke-dashoffset: 40;
  transition: stroke-dashoffset 0.3s ease 0.1s;
}

/* Checked State */
.ios-checkbox input:checked + .checkbox-wrapper .checkbox-bg {
  background: #5f4fe9;
  border-color: #5f4fe9;
}

.ios-checkbox input:checked + .checkbox-wrapper .checkbox-icon {
  transform: scale(1);
}

.ios-checkbox input:checked + .checkbox-wrapper .check-path {
  stroke-dashoffset: 0;
}

/* Hover Effects
.ios-checkbox:hover .checkbox-wrapper {
  transform: scale(1.05);
} */

/* Active Animation */
.ios-checkbox:active .checkbox-wrapper {
  transform: scale(0.95);
}

/* Focus Styles */
.ios-checkbox input:focus + .checkbox-wrapper .checkbox-bg {
  box-shadow: 0 0 0 4px #dbeafe;
}

@media (max-width: 768px) {
        .formbold-main-wrapper {
            padding: 0px;
            display: block;
        }
        .formbold-form-wrapper {
            min-width: auto;
            width: 100%;
            padding: 20px;
        }
        .formbold-form-input {
            width: 100%;
        }
        .formbold-navbar {
            flex-direction: row;
            overflow: auto;
        }

        .formbold-navbar .formbold-navbar-btn {
            width: 100%;
            text-align: left;
        }
        .formbold-btn {
            width: 100%;
        }
        img {
            width: 100%;
            height: auto;
        }
    }



    .wizard-progress{
  display: table;
  width: 100%;
  table-layout: fixed;
  position:relative;
  
  .step{
    display: table-cell;
    text-align: center;
    vertical-align: top;
    overflow: visible;
    position:relative;
    font-size: 14px;
    color: #4e005e;
    font-weight: bold;
/*    
    &:not(:last-child):before{
      content: '';
      display:block;
      position: absolute;
      left: 50%;
      top: 80px;
      background-color: #07c;
      height: 6px;
      width: 100%;
      border: 1px solid #9C27B0 !important;
    }

    
    .node{
      position: absolute;
      top: 45px;
      left: 27%;
      margin-left: -18px;
    }
*/  
    &.complete{
      &:before{
        background-color: #07c;
        border-color: #4B0082;
      }
      .node{
        border-color: #4B0082;
        
        &:before{
          font-family: FontAwesome;
        }
      }
    }
    
    &.in-progress{
      &:before{
        background: #07c;
        background: -moz-linear-gradient(left,  #07c 0%, #fff 100%);
        background: -webkit-linear-gradient(left,  #07c 0%, #fff 100%);
        background: linear-gradient(to right, #9C27B0 0%, #fff 100%);
        filter: progid:DXImageTransform.Microsoft.gradient(     startColorstr='#07c', endColorstr='#fff',GradientType=1 );
      }
      .node{
        border-color: #07c;
      }
    }
  }
}

@media (max-width: 768px) {
    .page-content-wrapper .container {
        padding-left: 0rem;
        padding-right: 0rem;
    }

    .container {
        padding-left: 0 !important;
        padding-right: 0 !important;
    }

    .completed .node::before {
    font-size: 25px;
    }

    .current .node::before {
    font-size: 25px;
    }

    .error .node::before {
    font-size: 25px;
    }
   
   .wizard-progress {
        & .step {
            &:not(:last-child):before {
                width: 100%; 
                top: 70px; 
                height: 3.5px; 
            }
        }
    }

.wizard-progress {
        & .step {
          .node {
            height: 50px;
            width: 50px;
            border-radius: 50px;
            border: 3.5px solid #4B0082;
            left: 38%;
        }
    }
}
    .wizard-progress .step {
        position: relative;
    }

    .wizard-progress .step span {
        visibility: hidden; /* Hide labels by default */
        opacity: 0;
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        position: absolute;
       /* background: #4CAF50; */
        background: #4B0082;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        white-space: nowrap;
        font-size: 12px;
        top: -5px; /* Position above the step */
        left: 50%;
        transform: translateX(-50%) scale(0.95);
        pointer-events: none;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1); 
    }

    .wizard-progress .step:hover span {
        visibility: visible;
        opacity: 1;
        transform: translateX(-50%) scale(1);
    }
    
    .wizard-progress .step:hover {
        background: none !important;
        filter: none !important;
    }
} 
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function toggleDescription(id) {
    var descBox = document.getElementById(id);
    if (descBox.style.display === "inline-block") {
        descBox.style.display = "none";
    } else {
        descBox.style.display = "inline-block";
    }
}
// MultiSelect Functions
function fetchOptions(fieldname, doctype) {
    let dropdown = document.getElementById(`multi-dropdown-${fieldname}`);
    if (dropdown.innerHTML.trim() !== "") {
        dropdown.style.display = 'block';
        return;
    }

    frappe.call({
        method: "demo_app.api.get_doctype_records",
        args: { doctype: doctype },
        callback: function(response) {
            dropdown.innerHTML = "";
            if (!response.message || response.message.length === 0) {
                dropdown.innerHTML = "<div class='no-data'>No options found</div>";
                return;
            }

            response.message.forEach(doc => {
                let optionElement = document.createElement("div");
                optionElement.innerText = doc.name;
                optionElement.classList.add("dropdown-option");
                optionElement.setAttribute("onclick", `selectMultiOption('${fieldname}', '${doc.name}')`);
                dropdown.appendChild(optionElement);
            });
            dropdown.style.display = 'block';
        }
    });
}

function selectMultiOption(fieldname, value) {
    let inputContainer = document.getElementById(`input-${fieldname}`);
    let existingItems = inputContainer.querySelectorAll('.selected-item');
    for (let item of existingItems) {
        if (item.innerText.includes(value)) return;
    }

    let selectedItem = document.createElement("div");
    selectedItem.classList.add("selected-item");
    selectedItem.innerHTML = `${value} <span class="remove-btn" onclick="removeMultiOption(this)">❌</span>`;
    inputContainer.appendChild(selectedItem);

    let placeholder = inputContainer.querySelector(".placeholder");
    if (placeholder) placeholder.remove();

    inputContainer.style.minHeight = `${inputContainer.scrollHeight}px`;
    document.getElementById(`multi-dropdown-${fieldname}`).style.display = "none";
}

function removeMultiOption(element) {
    let selectedItem = element.parentElement;
    let inputContainer = selectedItem.parentElement;
    selectedItem.remove();

    if (inputContainer.children.length === 0) {
        inputContainer.innerHTML = '<span class="placeholder">Select Files...</span>';
    }
    inputContainer.style.minHeight = "40px";
}

// Link Field Functions
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("input[data-doctype]").forEach(function (input) {
        let fieldname = input.name;
        let container = input.parentElement;

        // Icon container
        let iconContainer = document.createElement("div");
        iconContainer.className = "link-icons";

        //  Clear Icon
        let clearIcon = document.createElement("i");
        clearIcon.className = "fa fa-times clear-icon";
        clearIcon.style.display = "none";

        //  Open Icon
        let openIcon = document.createElement("i");
        openIcon.className = "";
        openIcon.style.display = "none";

        clearIcon.onclick = function () {
            input.value = "";
            hideDropdown(input);
            clearIcon.style.display = "none";
            openIcon.style.display = "none";
        };

        openIcon.onclick = function () {
            if (input.value.trim()) {
                let doctype = input.getAttribute("data-doctype");
                let docname = input.value.trim();
                window.open("/app/" + doctype + "/" + docname, "_blank");
            }
        };

        iconContainer.appendChild(clearIcon);
        iconContainer.appendChild(openIcon);
        container.appendChild(iconContainer);

        // On focus show dropdown + icons
        input.onfocus = function () {
            if (input.value.trim()) {
                clearIcon.style.display = "inline";
                openIcon.style.display = "inline";
            }
            fetchLinkedOptions(input, clearIcon, openIcon);
        };

        // On input always show icons when typing anything
        input.oninput = function () {
            if (input.value.trim()) {
                clearIcon.style.display = "inline";
                openIcon.style.display = "inline";
            } else {
                clearIcon.style.display = "none";
                openIcon.style.display = "none";
            }
            fetchLinkedOptions(input, clearIcon, openIcon);
        };
    });
});

// Modified dropdown logic
function fetchLinkedOptions(input, clearIcon, openIcon) {
    let dropdown = document.getElementById("dropdown-" + input.name);
    dropdown.innerHTML = "";
    dropdown.style.display = "block";

    let doctype = input.getAttribute("data-doctype");
    frappe.call({
        method: "frappe.client.get_list",
        args: {
            doctype: doctype,
            fields: ["name"],
            limit_page_length: 100,
            filters: [["name", "like", `%${input.value}%`]]
        },
        callback: function (r) {
            if (r.message) {
                r.message.forEach(function (doc) {
                    let option = document.createElement("div");
                    option.className = "dropdown-item";
                    option.innerHTML = doc.name;
                    option.onclick = function () {
                        input.value = doc.name;
                        dropdown.style.display = "none";

                        // Show icons when value selected
                        clearIcon.style.display = "inline";
                        openIcon.style.display = "inline";
                    };
                    dropdown.appendChild(option);
                });
            }
        }
    });
}

function hideDropdown(input) {
    let dropdown = document.getElementById("dropdown-" + input.name);
    dropdown.style.display = "none";
}

document.addEventListener("mousedown", function (event) {
    let dropdowns = document.getElementsByClassName("link-dropdown");
    for (let i = 0; i < dropdowns.length; i++) {
        if (!dropdowns[i].contains(event.target) && !event.target.matches("input[data-doctype]")) {
            dropdowns[i].style.display = "none";
        }
    }
    let multiDropdowns = document.getElementsByClassName("multi-dropdown");
    for (let i = 0; i < multiDropdowns.length; i++) {
        if (!multiDropdowns[i].contains(event.target) && !event.target.matches(".custom-textbox")) {
            multiDropdowns[i].style.display = "none";
        }
    }
});


let currentTab = 0;
const sections = document.querySelectorAll('.formbold-section');
const navs = document.querySelectorAll('.form-navigation');
const steps = document.querySelectorAll('.step');
const maxVisibleSteps = 5;
let startStep = 0;
let isFormSaved = false;

function showTab(index) {
    sections.forEach((section, i) => {
        section.style.display = i === index ? 'block' : 'none';
    });
    navs.forEach((nav, i) => {
        nav.style.display = i === index ? 'flex' : 'none';
    });

    updateStepIndicator();
}

function changeTab(step) {
    steps[currentTab].classList.remove("completed", "current", "error");
    steps[currentTab].querySelector(".node").innerHTML = "";

    currentTab += step;

    if (currentTab >= sections.length) currentTab = sections.length - 1;
    if (currentTab < 0) currentTab = 0;

    showTab(currentTab);

    if (step === 1 && currentTab > 0) {
        steps[currentTab - 1].classList.add("completed");
        steps[currentTab - 1].querySelector(".node").innerHTML = "✔";
    }

    updateStepIndicator();
} 

/* function changeTab(step) {
    if (!validateCurrentTab(currentTab)) {
        return; // Stop tab change if validation fails
    }

    steps[currentTab].classList.remove("completed", "current", "error");
    steps[currentTab].querySelector(".node").innerHTML = "";

    currentTab += step;

    if (currentTab >= sections.length) currentTab = sections.length - 1;
    if (currentTab < 0) currentTab = 0;

    showTab(currentTab);

    if (step === 1 && currentTab > 0) {
        steps[currentTab - 1].classList.add("completed");
        steps[currentTab - 1].querySelector(".node").innerHTML = "✔";
    }

    updateStepIndicator();
}

function validateCurrentTab(index) {
    let tabValid = true;
    let section = sections[index];
    let step = steps[index];

    $(section).find("input[required], textarea[required], select[required]").each(function () {
        let input = $(this);
        if (input.val().trim() === '') {
            input.css("border", "2px solid red");
            tabValid = false;
        } else {
            input.css("border", "1px solid #ccc");
        }

        input.on("input", function () {
            input.css("border", "1px solid #ccc");
        });
    });

    // Show red exclamation if invalid
    if (!tabValid) {
        step.classList.add("error");
        step.querySelector(".node").innerHTML = "!";
        step.querySelector(".node").style.backgroundColor = "red";
    } else {
        step.classList.remove("error");
        step.querySelector(".node").innerHTML = "";
        step.querySelector(".node").style.backgroundColor = "";
    }

    return tabValid;
} */ 

 steps.forEach((step, index) => {
    step.addEventListener("click", function() {
        currentTab = index;
        showTab(currentTab);
    });
});  

 /* steps.forEach((step, index) => {
    step.addEventListener("click", function () {
        if (!validateCurrentTab(currentTab)) {
            return;
        }

        currentTab = index;
        showTab(currentTab);
    });
}); */


function updateStepIndicator(tabsWithErrors = new Set()) {
    if (currentTab >= startStep + maxVisibleSteps) {
        startStep++;
    } else if (currentTab < startStep) {
        startStep--;
    }

    steps.forEach((step, i) => {
        if (i < startStep || i >= startStep + maxVisibleSteps) {
            step.classList.add("hidden");
        } else {
            step.classList.remove("hidden");
        }

        if (i < currentTab) {
            step.classList.add("completed");
            step.querySelector(".node").innerHTML = "";
        } else if (i === currentTab) {
            step.classList.add("current");
            step.querySelector(".node").innerHTML = "";
        } else {
            step.classList.remove("completed", "error", "current");
            step.querySelector(".node").innerHTML = "";
            step.querySelector(".node").style.backgroundColor = "";
        }
    });

    let visibleSteps = [...steps].filter(step => !step.classList.contains("hidden"));
    if (visibleSteps.length > 0) {
        visibleSteps.forEach(step => step.classList.remove("last-visible"));
        visibleSteps[visibleSteps.length - 1].classList.add("last-visible");
    }
}

showTab(currentTab);
updateStepIndicator();

let recordName = localStorage.getItem("record_name"); // Store existing record name

function autoSave() {
    let data = {};

    if (recordName) {
        data["name"] = recordName; // Ensure same Draft is updated
    }

    $("form :input").each(function () { 
        let input = $(this);
        let name = input.attr("name");
        let value = input.val();

        if (name) {
            data[name] = value;
        }
    });

    console.log("Auto-saving data:", data);

    frappe.call({
        method: "demo_app.www.FORMS.update_data",
        args: { data: JSON.stringify(data) },
        callback: function (r) {
            if (!r.exc) {
                console.log("Form auto-saved successfully");
                recordName = r.message.name;  // Update record name after first save
                localStorage.setItem("record_name", recordName); // Store record name
            }
        },
    });
}

// Auto-save on input change
 $("form :input").on("input", function() { 
 autoSave();
});

$("#submitButton").on("click", function () {
    if (validateAllTabsOnSubmit()) {
        // Proceed with final form submission
        console.log("All good! Submitting form...");
        // frappe.call(...) or your custom submission logic here
    } else {
        console.log("Validation failed! Check required fields.");
    }
});

function validateOnSubmit() {
    let firstInvalidTab = null;
    let errorMessages = [];
    
    $(".formbold-section").each(function (index) {
        let tabHasError = false;

        $(this).find("input[required], textarea[required], select[required]").each(function () {
            let input = $(this);
            if (input.val().trim() === '') {
                input.css("border", "2px solid red");
                tabHasError = true;

                let fieldLabel = input.attr("placeholder") || input.attr("name") || "Field"; 
                let sectionName = $(this).closest(".formbold-section").attr("data-tab-name") || `Tab ${index + 1}`;

                errorMessages.push(`Error: Value missing for ${sectionName}: ${fieldLabel}`);
            } else {
                input.css("border", "1px solid #ccc");
            }

            // Reset border when user starts typing
            input.on("input", function () {
                input.css("border", "1px solid #ccc");
            });
        });

        // **Set firstInvalidTab to first tab with error**
        if (tabHasError && firstInvalidTab === null) {
            firstInvalidTab = index;
        }
      });
   
      if (errorMessages.length > 0) {
        frappe.msgprint(errorMessages.join("<br>"), "Message");

        if (firstInvalidTab !== null) {
            console.log(`Moving to Tab: ${firstInvalidTab + 1}`);
            goToTab(firstInvalidTab); // **Switch to First Invalid Tab**
        }
        return false;
    }

    return true;
}

function goToTab(index) {
    $(".tab-content").removeClass("active");
    $(".tab-content").eq(index).addClass("active");

    $(".step").removeClass("active");
    $(".step").eq(index).addClass("active");

    currentTab = index; // Update the active tab index
}

$(document).ready(function() {
    $(".formbold-btn").off("click").on("click", function(event) {
        event.preventDefault();

        if (!validateOnSubmit()) {
            return;
        }

        var data = {};

        $("form :input").each(function() {
            var input = $(this);
            var name = input.attr("name");
            var value = input.val();

            if (name) {
                    data[name] = value;
            }
        });

        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var file_content = e.target.result.split(",")[1];
                frappe.call({
                    method: "frappe.client.insert",
                    args: {
                        doc: {
                            doctype: "File",
                            file_name: file.name,
                            content: file_content,
                            is_private: 1
                        }
                    },
                    callback: function(r) {
                        if (!r.exc) {
                            data["pdf"] = r.message.file_url;
                            submitMedicalForm(data);
                        } else {
                            frappe.msgprint("File upload failed", "Error");
                        }
                    }
                });
            };
            reader.readAsDataURL(file);
        } else {
            submitMedicalForm(data);
        }
    });
});

function submitMedicalForm(data) {
    frappe.call({
        method: "frappe.client.insert",
        args: {
            doc: {
                doctype: "Medical",
                ...data
            }
        },
        callback: function(r) {
            if (!r.exc) {
                frappe.msgprint("Thank you for your message", "Message Sent");
            } else {
                frappe.msgprint("There was an error submitting your form", "Error");
            }
        }
    });
}

  async function uploadFileToNodeServer(file) {
    const formData = new FormData();
    formData.append("files", file);

    try {
        const response = await fetch("http://192.168.1.13:7001/upload-any", {
            method: "POST",
            body: formData
        });

        const result = await response.json();
        const uploadedMsg = result?.messages?.[0] || "";

        // Extract file ID if you follow that pattern
        const match = uploadedMsg.match(/File\s+'(.+?)'/);
        return match ? match[1] : "";
    } catch (err) {
        console.error("Upload failed", err);
        frappe.msgprint("File upload failed.");
        return "";
    }
} 

function addFiles(event, fileListId) {
    const fileList = document.getElementById(fileListId);
    const files = event.target.files;

    // Get values from hidden inputs
    const formId = document.getElementById("form-id-hidden")?.value;
    const username = document.getElementById("username-hidden")?.value;
    
    console.log("Uploading for formId:", formId, "username:", username);

    if (!formId || !username) {
        console.error("Missing formId or username");
        frappe.msgprint("Missing form ID or user. Please try again.");
        return;
    }

    for (let i = 0; i < files.length; i++) {
        const existingFile = [...fileList.children].some(item =>
            item.querySelector('span').innerText === files[i].name
        );
        if (!existingFile) {
            const fileURL = URL.createObjectURL(files[i]);

            fileList.innerHTML += `
                <div class="file-item">
                    <span>${files[i].name}</span>
                    <div class="progress-bar"><div class="progress-bar-fill"></div></div>
                    <button type="button" class="remove-btn" onclick="this.parentElement.remove()">×</button>
                </div>
            `;

            const formData = new FormData();
            formData.append("username", username);
            formData.append("formId", formId);
            formData.append("file", files[i]);

            fetch("http://192.168.1.13:7001/upload-any", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                console.log("Upload success:", data);
            })
            .catch(err => {
                console.error("Upload failed:", err);
            });
        }
    }
}

function handleDrop(event, fileListId) {
    event.preventDefault();
    addFiles({ target: { files: event.dataTransfer.files } }, fileListId);
}


  frappe.ready(function () {
        $(".formbold-navbar-btn").click(function() {
            // Remove active class from all buttons
            $(".formbold-navbar-btn").removeClass("active");
            $(this).addClass("active");

            // Hide all sections
            $(".formbold-section").removeClass("active").hide();

            // Show the selected section with fade effect
            let target = $(this).data("target");
            $(target).fadeIn().addClass("active");
        });
      $(".formbold-btn").off("click").on("click", function (event) {
          event.preventDefault(); // Prevent default form submission
  
          var data = {}; // Object to store form data dynamically
          var isValid = true;
  
          // Loop through all form inputs and collect data
          $("form :input").each(function () {
              var input = $(this);
              var name = input.attr("name");
              var type = input.attr("type");
              var value = input.val();
  
              if (name) {
                  if (type === "checkbox") {
                    var c_name = input.attr("child_name");
                    if (!data[name]) {
                      data[name] = [];
                    }
                    
                    if (input.is(":checked")) {
                      data[name].push({ [c_name]: value });
                    }
                  } else if (type === "radio") {
                      if (input.is(":checked")) {
                          data[name] = value;
                      }
                  } else {
                      data[name] = value;
                  }
              }
          });
  
          // Submit data using frappe.call()
          console.log(data);
          frappe.call({
              type: "POST",
              method: "demo_app.www.FORMS.update_data",
              args: {
				        data:data,
			        },
              callback: function (r) {
                  if (!r.exc) {
                      frappe.msgprint("{{ _('Thank you for your message') }}", "{{ _('Message Sent') }}");
                  }
              },
          });
      });
  });

function submitForm(isSubmit = false) {
    let data = {};

    if (recordName) {
        data["name"] = recordName; // Ensure same Draft updates
    }

    $("form :input").each(function () {
        let input = $(this);
        let name = input.attr("name");
        let value = input.val();
        if (name) {
            data[name] = value;
        }
    });

    console.log("Submitting Data:", data, "Submit:", isSubmit);

    frappe.call({
        method: "demo_app.www.FORMS.update_data",
        args: { data: JSON.stringify(data), submit: isSubmit },
        callback: function (r) {
            if (!r.exc) {
                recordName = r.message.name; // Store updated record name
                localStorage.setItem("record_name", recordName);
                
                setTimeout(function () {
                    window.location.reload();
                }, 500);
            }
        }
    });
}

// Save as Draft
function saveDraft() {
    submitForm(false);
}

// Submit Form
function submitRecord() {
    submitForm(true);
}


frappe.ready(function () {
    frappe.call({
        method: "demo_app.www.FORMS.get_user_draft",
        callback: function (r) {
            if (r.message.exists) {
                let draftName = r.message.name;

                frappe.confirm(
                    "You have an unsaved draft. Do you want to continue?",
                    function () {
                        // User chose "Yes" -> Load the draft
                        localStorage.setItem("record_name", draftName);
                        loadDraftData(draftName);
                    },
                    function () {
                        // User chose "No" -> Start a new form
                        localStorage.removeItem("record_name");
                        deleteDraft(draftName);
                        resetForm();
                    }
                );
            }
        },
    });
});

function deleteDraft(recordName) {
    frappe.call({
        method: "demo_app.www.FORMS.delete_draft",
        args: { name: recordName },
        callback: function (r) {
            if (!r.exc) {
                console.log("Draft deleted successfully.");
            } else {
                console.log("Error deleting draft.");
            }
        }
    });
}


function loadDraftData(recordName) {
    frappe.call({
        method: "frappe.client.get",
        args: {
            doctype: "Medical",
            name: recordName,
        },
        callback: function (r) {
            if (r.message) {
                let data = r.message;
                console.log("Loading draft:", data);

               $("form :input").each(function () {
                    let input = $(this);
                    let name = input.attr("name");

                    if (name && data[name]) {
                        input.val(data[name]);
                    }
                });
            }
        },
    });
}

function resetForm() {
    $("form :input").val("");  // Clear form fields
}
  </script>
{% endblock %}


